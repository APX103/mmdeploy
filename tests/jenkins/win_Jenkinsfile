pipeline {
    agent { label 'deploy_win2' }
    parameters {
        string(
            name: 'CONFIG',
            defaultValue:'Windows-3080_cuda-113_master_full-test.config',
            description: 'select config'
        )
        string(
            name: 'codebase_list',
            defaultValue:"mmdet mmcls mmedit mmocr mmpose mmrotate mmseg",
            description: 'select codebase'
        )
        string(
            name: 'exec_performance',
            defaultValue: 'y',
            description: 'exec performance or not,use y/n'
        )
        string(
            name: 'mmdeploy_branch',
            defaultValue: 'master',
            description: 'select branch'
        )
        string(
            name: 'max_job_nums',
            defaultValue: '2'
        )
        string(
            name: 'repo_url',
            defaultValue: 'https://github.com/open-mmlab/mmdeploy.git'
        )

    }


    stages {
        stage('Convert') {
            steps {
                bat """
                    @ECHO ON
                    Write-Host "$pwd"
                    Copy-Item -Path $pwd/tests/jenkins/conf/$winconfig -Destination $pwd/tests/jenkins/conf/win_tmp.config -Recurse -Force -Verbos
                    Get-content $pwd/tests/jenkins/conf/win_tmp.config
                    (Get-content $pwd/tests/jenkins/conf/win_tmp.config) -replace 'codebase_list=.*',"codebase_list=${params.codebase_list}" | Set-Content $pwd/tests/jenkins/conf/win_tmp.config -Verbos
                    (Get-content $pwd/tests/jenkins/conf/win_tmp.config) -replace 'exec_performance=.*',"exec_performance=${params.exec_performance}" | Set-Content $pwd/tests/jenkins/conf/win_tmp.config -Verbos
                    (Get-content $pwd/tests/jenkins/conf/win_tmp.config) -replace 'repo_url=.*',"repo_url=${params.repo_url}" | Set-Content $pwd/tests/jenkins/conf/win_tmp.config -Verbos
                    (Get-content $pwd/tests/jenkins/conf/win_tmp.config) -replace 'mmdeploy_branch=.*',"mmdeploy_branch=${params.mmdeploy_branch}" | Set-Content $pwd/tests/jenkins/conf/win_tmp.config -Verbos
                    (Get-content $pwd/tests/jenkins/conf/win_tmp.config) -replace 'max_job_nums=.*',"max_job_nums=${params.max_job_nums}" | Set-Content $pwd/tests/jenkins/conf/win_tmp.config -Verbos
                    Get-content $pwd/tests/jenkins/conf/win_tmp.config
                    pwsh.exe -ExecutionPolicy Bypass -File .\\tests\\jenkins\\scripts\\test_convert.ps1
                """
            }
        }

    }
}
